{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{% static 'runs/style.css' %}">
{% endblock %}

{% block javascript %}
    <script type="text/javascript" src="{% static 'js/jquery.js' %}"></script>
    <script>
        // Sets up an event listener that sends a POST request with AJAX to the server to provide
        // the correct parameter dropdowns as HTML when the selected method changes.
        // It updates the page with the new dropdowns or displays an error message if something goes wrong.
        // The CSRF token is included in the data object to prevent cross-site request forgery attacks.

        $(document).ready(function () {
            $("#chosen_method").change(function () {
                const selected_method = $(this).val();

                $.ajax({
                    url: "{% url 'runs:change_method' run_name %}",
                    type: "POST",
                    data: {
                        method: selected_method,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function (response) {
                        $("#method_parameters").html(response.parameters);
                        $("#plot_parameters").html(response.plot_parameters);
                    }
                }).fail(function (e) {
                    console.log('Error:', e);
                    alert(e.responseJSON.error); // alert error message to user
                })
            });
            $("#method_parameters").on("change", ".named", function () {
                const id = $(this).attr("id");
                const step_name = $(this).val();
                console.log(id, step_name)
                $.ajax({
                    url: "{% url 'runs:outputs_of_step' run_name %}",
                    type: "POST",
                    data: {
                        step_name: step_name,
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function (response) {
                        console.log(response)
                        const outputs = $(`#${id}_outputs`);
                        outputs.empty();
                        $.each(response, function (index, value) {
                            outputs.append($("<option></option>").attr("value", value).text(value))
                        })
                    }
                })
            });
        });
    </script>
{% endblock %}

{% block content %}

<div class="wrapper">

    <div id="content">
        {{ run_name }}
        <br>
        <b>history</b>
        <br>

    {% for step in displayed_history %}
        {{ step.location }}<br>
        {% for field in step.fields %}
            {{ field }}<br>
        {% endfor %}
        {% if step.name %}
            Name: {{ step.name }}<br>
        {% else %}
            {% include "runs/form_add_name.html" with index=step.index %}
        {% endif %}

        {% for plot in step.plots %}
            <div style="width:600;height:500">
                {{ plot|safe }}
            </div>
        {% endfor %}

        <br>
    {% endfor %}

    <br>
    {{ location }}
    <br>
    <form action="{% url 'runs:calculate' run_name %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ method_dropdown }}
        <div id="method_parameters">
            {% include "runs/fields.html" with fields=fields %}
        </div>
        <input type="submit" value="Calculate" class="btn btn-grey">
    </form>
    <form action="{% url 'runs:plot' run_name %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div id="plot_parameters">
            {% include "runs/fields.html" with fields=plot_fields %}
        </div>
        <input type="submit" value="Plot" class="btn btn-grey" {% if not show_next %} disabled {% endif %} >
    </form>

    {% for plot in current_plots %}
        <div style="width:600;height:500">
            {{ plot|safe }}
        </div>
    {% endfor %}

    <form action="{% url 'runs:next' run_name %}" method="post">
        {% csrf_token %}
        {{ name_field }}
        <button class="btn btn-grey" {% if not show_next %} disabled {% endif %}>Next</button>
    </form>

    <form action="{% url 'runs:back' run_name %}" method="post">
        {% csrf_token %}
        <button class="btn btn-grey" {% if not show_back %} disabled {% endif %}>Back</button>
    </form>
</div>
        <nav id="sidebar" class="bg-grey">
            {% include "runs/sidebar.html" with run_name=run_name workflow_steps=workflow_steps sidebar_dropdown=sidebar_dropdown %}
        </nav>
</div>
{% endblock %}
