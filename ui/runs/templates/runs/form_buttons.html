<script>
    let current_parameters
    let current_plot_parameters
    let calc_params_match
    let plotted_for_parameters
    let calc_form_data

    function get_current_parameters(callback) {
        $.ajax({
            url: "{% url 'runs:current_parameters' run_name %}",
            type: "GET",
            success: function (response) {
                current_parameters = response
                callback()
            }
        }).fail(function (e) {
            console.log('Error', e);
            alert(e.responseJSON.error)
        })
    }

    async function get_current_plot_parameters(callback) {
        $.ajax({
            url: "{% url 'runs:current_plot_parameters' run_name %}",
            type: "GET",
            success: function (response) {
                current_plot_parameters = response
                callback()
            }
        }).fail(function (e) {
            console.log('Error', e);
            alert(e.responseJSON.error)
        })
    }

    async function get_results_exist(callback) {
        $.ajax({
            url: "{% url 'runs:results_exist' run_name %}",
            type: "GET",
            success: function (response) {
                results_exist = response["results_exist"]
                callback()
            }
        }).fail(function (e) {
            console.log('Error', e);
            alert(e.responseJSON.error)
        })
    }

    async function get_plotted_for_parameters(callback) {
        $.ajax({
            url: "{% url 'runs:plotted_for_parameters' run_name %}",
            type: "GET",
            success: function (response) {
                plotted_for_parameters = response
                callback()
            }
        }).fail(function (e) {
            console.log('Error', e);
            alert(e.responseJSON.error)
        })
    }

    get_clean_form_data = function (form) {
        let formDataArray = form.serializeArray()
        let formDataDict = {};
        for (let i = 0; i < formDataArray.length; i++) {
            formDataDict[formDataArray[i].name] = formDataArray[i].value;
        }
        delete formDataDict["csrfmiddlewaretoken"]
        return formDataDict
    }


    disable_plot = function (bool) {
        $('#plot_parameters_submit').prop('disabled', bool)
    }

    disable_calc = function (bool) {
        $('#calculate_parameters_submit').prop('disabled', bool)
    }

    function isEmptyDict(obj) {
        return Object.keys(obj).length == 0
    }

    function trigger_plot_change() {
        get_results_exist(function () {
            $('#plot_form').trigger('change');
        })
    }

    function plotted_current_match() {
        if (isEmptyDict(plotted_for_parameters)) {
            return false
        }
        return Object.keys(current_parameters).every(key =>
            plotted_for_parameters.hasOwnProperty(key) && plotted_for_parameters[key] == current_parameters[key]
        );
    }

    equal_calc_parameters = function (form) {
        if (isEmptyDict(current_parameters)) {
            return false
        }

        let form_data = get_clean_form_data(form)
        calc_form_data = form_data
        return Object.keys(current_parameters).every(key =>
            form_data.hasOwnProperty(key) && form_data[key] == current_parameters[key]
        );
    }

    equal_plot_parameters = function (form) {
        if (isEmptyDict(current_plot_parameters)) {
            return false
        }

        let form_data = get_clean_form_data(form)
        return Object.keys(current_plot_parameters).every(key =>
            form_data.hasOwnProperty(key) && form_data[key] == current_plot_parameters[key]
        );
    }

    $(document).ready(function () {
        const calc_form = document.querySelector('#calc_form');
        const plot_form = document.querySelector('#plot_form');

        $('#calc_form').on('change', function () {
            if (equal_calc_parameters($(this))) {
                disable_calc(true)
                calc_params_match = true
            } else {
                disable_calc(false)
                calc_params_match = false
                trigger_plot_change()
            }
        })

        $('#plot_form').on('change', function () {
            if (!calc_form_data || calc_form_data["chosen_method"] !== current_parameters["chosen_method"]) {
                disable_plot(true)
                return
            }

            if (!plotted_current_match() && results_exist) {
                disable_plot(false)
                return
            }

            if (equal_plot_parameters($(this)) || !calc_params_match) {
                disable_plot(true)
            } else {
                disable_plot(false)
            }
        });

        get_current_parameters(function () {
            get_current_plot_parameters(function () {
                get_plotted_for_parameters(function () {
                    $('#calc_form').trigger('change');
                    trigger_plot_change()
                })
            })
        })

    })
</script>
